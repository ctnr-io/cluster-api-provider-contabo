
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ContaboCluster
metadata:
  name: test-cluster
  namespace: contabo-e2e-test
spec:
  controlPlaneEndpoint:
    host: vmi2510653.contaboserver.net
    port: 6443
  privateNetwork:
    region: EU
---
apiVersion: v1
kind: Secret
metadata:
  name: test-cluster-encryption-key
  namespace: contabo-e2e-test
type: Opaque
stringData:
  encryption-config: |
    apiVersion: apiserver.config.k8s.io/v1
    kind: EncryptionConfiguration
    resources:
      - resources:
          - secrets
        providers:
          - secretbox:
              keys:
                - name: secretbox-key-0
                  secret: yI9EOaNXPno3PZh4z15DB2lB4HcXz0LaF3ZrndIOx+E=
          - identity: {}
---
apiVersion: cluster.x-k8s.io/v1beta2
kind: Cluster
metadata:
  name: test-cluster
  namespace: contabo-e2e-test
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
    services:
      cidrBlocks:
      - 10.96.0.0/12
  infrastructureRef:
    apiGroup: infrastructure.cluster.x-k8s.io
    kind: ContaboCluster
    name: test-cluster
  controlPlaneRef:
    apiGroup: controlplane.cluster.x-k8s.io
    kind: KubeadmControlPlane
    name: test-control-plane
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ContaboMachineTemplate
metadata:
  name: test-control-plane
  namespace: contabo-e2e-test
spec:
  template:
    spec:
      instance:
        name: vmi2510653
        provisioningType: ReuseOnly
---
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: KubeadmControlPlane
metadata:
  name: test-control-plane
  namespace: contabo-e2e-test
spec:
  replicas: 1
  version: v1.34.1
  machineTemplate:
    infrastructureRef:
      kind: ContaboMachineTemplate
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
      name: test-control-plane
  kubeadmConfigSpec:
    clusterConfiguration:
      apiServer:
        extraArgs:
          encryption-provider-config: /etc/kubernetes/encryption-config.yaml
        extraVolumes:
          - name: encryption-config
            hostPath: /etc/kubernetes/encryption-config.yaml
            mountPath: /etc/kubernetes/encryption-config.yaml
            readOnly: true
            pathType: File
    files:
      - path: /etc/kubernetes/encryption-config.yaml
        owner: root:root
        permissions: "0600"
        contentFrom:
          secret:
            name: test-cluster-encryption-key
            key: encryption-config
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: ContaboMachineTemplate
metadata:
  name: test-worker
  namespace: contabo-e2e-test
spec:
  template:
    spec:
      instance:
        productId: V78
        provisioningType: ReuseOnly
---
apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
kind: KubeadmConfigTemplate
metadata:
  name: test-worker
  namespace: contabo-e2e-test
---
apiVersion: cluster.x-k8s.io/v1beta2
kind: MachineDeployment
metadata:
  name: test-worker
  namespace: contabo-e2e-test
spec:
  clusterName: test-cluster
  replicas: 1
  selector:
    matchLabels:
      cluster.x-k8s.io/cluster-name: test-cluster
      cluster.x-k8s.io/deployment-name: test-worker
  template:
    metadata:
      labels:
        cluster.x-k8s.io/cluster-name: test-cluster
        cluster.x-k8s.io/deployment-name: test-worker
    spec:
      clusterName: test-cluster
      version: v1.34.1
      bootstrap:
        configRef:
          apiGroup: bootstrap.cluster.x-k8s.io
          kind: KubeadmConfigTemplate
          name: test-worker
      infrastructureRef:
        apiGroup: infrastructure.cluster.x-k8s.io
        kind: ContaboMachineTemplate
        name: test-worker